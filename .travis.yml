language: cpp

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8
      - rubygems

env:
  global:
    - OSRM_TIMEOUT: 60
    - OSRM_PORT: 5000

# we require sudo currently to install apt packages
# the trouble is that while we could install the apt packages
# using the sudo free "addons" method above that would run
# for every build (even the mason builds that do not need any
# apt packages). We do not want to pay the time cost of that for
# mason builds. So: I think we should request travis add some kind
# of boolean logic to disable the apt addon from running somehow
sudo: required

# TODO - caching will not work until we achieve sudo:false
#cache:
#  directories:
#  - $HOME/.ccache
#  - vendor/bundle

matrix:
  include:
    # Linux + apt packages + extra tools
    - os: linux
      compiler: gcc
      env: BUILD_TYPE=LINUX_DEBIAN CMAKEOPTIONS="-DBUILD_SHARED_LIBS=ON -DBUILD_TOOLS=1" JOBS=2
    # Linux + apt packages + debug build
    - os: linux
      compiler: gcc
      env: BUILD_TYPE=LINUX_DEBIAN TARGET=Debug JOBS=1
    # Coverage on OSX (because clang++ on OS X is less likely to be OOM killed)
    - os: osx
      compiler: clang
      env: BUILD_TYPE=MASON COVERAGE=true TARGET=Debug JOBS=4
    # Linux + mason packages
    - os: linux
      compiler: gcc
      env: BUILD_TYPE=MASON JOBS=2
    # OS X + mason packages
    - os: osx
      compiler: clang
      env: BUILD_TYPE=MASON JOBS=6

before_install:
 - if [[ $(uname -s) == 'Linux' ]]; then
    export CXX="g++-4.8";
    export CC="gcc-4.8";
   fi
 # install deps
 - source ./scripts/${BUILD_TYPE}-install.sh
 # osmosis build
 - if [[ $(uname -s) == 'Darwin' ]]; then brew install osmosis; else curl -s https://gist.githubusercontent.com/DennisOSRM/803a64a9178ec375069f/raw/ | sudo bash; fi

install:
 - source scripts/build.sh
 - make -j${JOBS}
 - make tests -j${JOBS} VERBOSE=1
 - make benchmarks
 - ./datastructure-tests
 - ./algorithm-tests

before_script:
 - rvm use 1.9.3
 - gem install bundler
 - bundle install --without development --deployment --jobs=3 --retry=3

script:
 - cd ..
 - cucumber -p verify
 - ./scripts/coverage_report.sh

branches:
  only:
    - master
    - develop
    - masonize

notifications:
 slack: mapbox:PRWTij9HAHnj6pQMDGjqzbfW
 irc:
  channels:
    - irc.oftc.net#osrm
  on_success: change
  on_failure: always
  use_notice: true
  skip_join: false

  recipients:
    - patrick@mapbox.com
  email:
    on_success: change
    on_failure: never       # revert this once it works
