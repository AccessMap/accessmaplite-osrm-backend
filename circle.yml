machine:
  xcode:
    version: 7.3
  environment:
    XCODE_SCHEME: "no"
    XCODE_WORKSPACE: "no"
    JOBS: 8
    CCACHE_TEMPDIR: /tmp/.ccache-temp
    CCACHE_COMPRESS: 1
    LLVM_VERSION: 3.8
    BUILD_TYPE: Debug
    BUILD_SHARED_LIBS: OFF
    COVERAGE: OFF

dependencies:
  cache_directories:
    - "~/.ccache"
    - "~/.apt-cache"
    - "mason_packages"
  pre:
    # https://discuss.circleci.com/t/add-ability-to-cache-apt-get-programs/598/3
    - sudo rm -rf /var/cache/apt/archives && sudo ln -s ~/.apt-cache /var/cache/apt/archives && mkdir -p ~/.apt-cache/partial
    - sudo wget -O - http://llvm.org/apt/llvm-snapshot.gpg.key | sudo apt-key add -
    - sudo add-apt-repository -y "deb http://llvm.org/apt/precise/ llvm-toolchain-precise-${LLVM_VERSION} main"
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - sudo apt-get update -y
  override:
    - sudo apt-get install clang-${LLVM_VERSION} -y
  post:
    - which clang-${LLVM_VERSION}
    - which clang++-${LLVM_VERSION}

database:
  pre:
    - sudo apt-get install clang-${LLVM_VERSION} libbz2-dev libstxxl-dev libstxxl1 libxml2-dev libzip-dev lua5.1 liblua5.1-0-dev libtbb-dev libgdal-dev libluabind-dev libboost-all-dev ccache
    - mkdir build && pushd build
    - export CC=clang-${LLVM_VERSION} CXX=clang++-${LLVM_VERSION}
    - cmake .. -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DBUILD_SHARED_LIBS=${BUILD_SHARED_LIBS:-OFF} -DCOVERAGE=${COVERAGE:-OFF} -DBUILD_TOOLS=1 -DENABLE_CCACHE=ON
    - make osrm-extract --jobs=3
    - make --jobs=${JOBS}
  override:
    - make tests --jobs=${JOBS}

test:
  override:
    - make benchmarks --jobs=${JOBS}
